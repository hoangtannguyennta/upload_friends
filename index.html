<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <title>FriendGram üì∏ | Share Your Vibes</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì∑</text></svg>">
</head>

<body>
    <header>
        <div class="header-container">
            <h1>ƒêƒÉng b√†i vi·∫øt c·ªßa m√¨nh üíõ</h1>
            <div class="header-count">
                <i class="fas fa-users"></i>
                <span>4</span>
            </div>
        </div>
    </header>

    <main>
        <!-- Friends avatars -->
        <div class="friends-section" id="friendsList"></div>

        <!-- New post form -->
        <div class="new-post-form" id="newPostForm">
            <div class="form-header">
                <div class="friend-avatar" id="selectedAvatar">ü§£</div>
                <select id="authorSelect">
                    <option value="üßë‚Äçüíª G√¥">üßë‚Äçüíª G√¥</option>
                    <option value="üë©‚Äçüé® Qu√¢n l·ªè">üë©‚Äçüé® Qu√¢n l·ªè</option>
                    <option value="üßë‚ÄçüöÄ Qu√¢n l·ªç">üßë‚ÄçüöÄ Qu√¢n l·ªç</option>
                    <option value="üë©‚Äçüåæ Bia l·ªè">üë©‚Äçüåæ Bia l·ªè</option>
                </select>
            </div>
            <textarea id="comment" placeholder="B·∫°n ƒëang nghƒ© g√¨? ‚ú®" rows="2"></textarea>
            <div class="form-actions">
                <input type="file" id="imageFile" hidden>
                <label for="imageFile" class="btn-image">
                    <i class="fas fa-image"></i>
                </label>
                <button onclick="uploadAndSave()" class="btn-post">
                    <i class="fas fa-paper-plane"></i>
                    <span>ƒêƒÉng</span>
                </button>
            </div>
            <img id="preview" style="display:none; margin-top:10px; width:100%; border-radius:12px;">
        </div>

        <!-- Feed -->
        <div class="feed" id="feed">
        </div>
    </main>
</body>

</html>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
    $(document).on("click", ".btn-comments", function () {
        var id = $(this).data("id");

        $('.post-comments[data-comments="' + id + '"]').slideToggle(200);
    });

</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        query,
        orderBy,
        deleteDoc,
        doc,
        where,
        serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


    const firebaseConfig = {
        apiKey: "AIzaSyAn6U45kKfYSWfrFhMcwIP6_N7VC9KO5FQ",
        authDomain: "mini-photo-app-891a5.firebaseapp.com",
        projectId: "mini-photo-app-891a5",
        storageBucket: "mini-photo-app-891a5.firebasestorage.app",
        messagingSenderId: "539133097244",
        appId: "1:539133097244:web:ca8540eeee7749f77036d9",
        measurementId: "G-H5H3C0F5MV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function uploadAndSave() {
        const file = document.getElementById("imageFile").files[0];
        const comment = document.getElementById("comment").value.trim();
        $(".btn-post").prop("disabled", true).css("opacity", "0.6");

        if (!file || !comment) {
            alert("Ch·ªçn ·∫£nh v√† nh·∫≠p comment!");
            return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "photo-mini");

        const response = await fetch(
            "https://api.cloudinary.com/v1_1/dsmp2jfcr/image/upload",
            {
                method: "POST",
                body: formData
            }
        );

        const data = await response.json();
        const imageUrl = data.secure_url;

        await addDoc(collection(db, "photos"), {
            imageUrl: imageUrl,
            comment: comment,
            auth: document.getElementById("authorSelect").value,
            createdAt: Date.now()
        });

        $(".btn-post").prop("disabled", false).css("opacity", "1");
        document.getElementById("imageFile").value = "";
        document.getElementById("comment").value = "";
        document.getElementById("preview").style.display = "none";

        loadData();
    }

    async function loadData() {
        const list = document.getElementById("feed");
        list.innerHTML = `<div class="spinner"></div>`;

        const q = query(collection(db, "photos"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);

        list.innerHTML = "";

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const id = doc.id;
            list.innerHTML += `
                <article class="post-card">
                    <div class="post-header">
                        <div class="d-flex">
                            <div class="post-author-avatar">üò≤</div>
                            <div class="post-author-info">
                                <span class="post-author-name">${data.auth}</span>
                                <span class="post-time">${new Date(data.createdAt).toLocaleString()}</span>
                            </div>
                        </div>
                        <button class="btn-delete" onclick="deletePost('${id}')">üóë Xo√°</button>
                    </div>

                    <img src="${data.imageUrl}" alt="" class="post-image" onerror="this.style.display='none'">

                    <div class="post-caption">${data.comment}</div>

                    <div class="post-actions">
                        <button class="action-btn liked" onclick="likePost('1')">
                            <i class="fas fa-heart"></i>
                            <span>4</span>
                        </button>
                        <button class="action-btn btn-comments" data-id="${id}">
                            <i class="fas fa-comment"></i>
                            <span class="comment-count-${id}">0</span>
                        </button>
                    </div>
                    
                    <div class="post-comments post-comments-${id}" id="post-comments-${id}" data-comments="${id}">
                    </div>
            </article>
        `;
            loadComments(id);
        });
    }

    window.uploadAndSave = uploadAndSave;
    loadData();

    async function deletePost(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?")) return;

        const q = query(
            collection(db, "comments"),
            where("postId", "==", id)
        );

        const snapshot = await getDocs(q);

        const deletePromises = [];
        snapshot.forEach((docSnap) => {
            deletePromises.push(deleteDoc(doc(db, "comments", docSnap.id)));
        });

        await Promise.all(deletePromises);

        await deleteDoc(doc(db, "photos", id));
        loadData();
    }

    window.deletePost = deletePost;


    $("#imageFile").on("change", function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
                $("#preview").attr("src", event.target.result).show();
            };
            reader.readAsDataURL(file);
        }
    });

    async function addComment(postId) {
        const input = document.getElementById(`input-${postId}`);
        const text = input.value.trim();

        if (!text) return;

        await addDoc(collection(db, "comments"), {
            postId: postId,
            text: text,
            author: document.getElementById("authorSelect").value,
            createdAt: serverTimestamp()
        });

        input.value = "";
        loadComments(postId);
    }

    window.addComment = addComment;

    async function loadComments(postId) {
        if (!postId) {
            console.error("postId is undefined!");
            return;
        }


        const commentBox = document.getElementsByClassName(`post-comments-${postId}`);
        const commentCountEl = document.getElementsByClassName(`comment-count-${postId}`);

        if (!commentBox || commentBox.length === 0) return;

        commentBox[0].innerHTML = `<div class="spinner"></div>`;

        try {
            const q = query(
                collection(db, "comments"),
                where("postId", "==", postId),
            );

            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("No comments found for postId:", postId);
                commentBox[0].innerHTML = `
                    <div class="comment-form">
                        <input type="text" id="input-${postId}" class="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
                        <button type="submit" class="btn-comment" onclick="addComment('${postId}')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>`;
                return;
            }

            if (commentCountEl && commentCountEl.length > 0) {
                const $box = $('.post-comments[data-comments="' + postId + '"]');
                $box.slideDown(200);
                commentCountEl[0].textContent = snapshot.size;
            }

            if (snapshot.size > 0) {
                let html = "";

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    html += `
                <div class="comment">
                    <span class="comment-author">${data.author || "Anonymous"}</span>
                    <span class="comment-text">${data.text}</span>
                </div>
            `;
                });

                html += `
                <div class="comment-form">
                    <input type="text" id="input-${postId}" class="comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
                    <button type="submit" class="btn-comment" onclick="addComment('${postId}')">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>`;

                commentBox[0].innerHTML = html;
            }
        } catch (error) {
            console.error("Error loading comments:", error);
            commentBox[0].innerHTML = "<p>Error loading comments.</p>";
        }
    }


</script>